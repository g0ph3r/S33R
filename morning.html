<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>S33R â€“ SOC Morning Call</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />

    <!-- Lightweight Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>

      /* PRINT-FRIENDLY STYLES */
      @media print {
        :root {
          /* forÃ§a fundo claro no print */
          color-scheme: light;
        }

        body {
          background: #ffffff !important;
          color: #000000 !important;
        }

        .page {
          box-shadow: none !important;
          background: #ffffff !important;
          margin: 0;
          padding: 0 18mm 18mm 18mm;
          max-width: 100%;
        }

        /* Esconde elementos de navegaÃ§Ã£o e controles */
        .minimal-navbar,
        .sidebar,
        .filters-bar,
        .site-footer,
        .loading,
        #btn-load-latest,
        #btn-load-previous,
        #btn-print,
        #previous-date {
          display: none !important;
        }

        /* Layout em uma coluna somente conteÃºdo */
        .layout {
          display: block;
        }

        .main-content {
          width: 100%;
          margin: 0;
          padding: 0;
        }

        .site-header {
          padding-bottom: 8px;
          border-bottom: 1px solid #ccc;
          margin-bottom: 12px;
        }

        .site-title {
          color: #000000 !important;
        }

        .site-subtitle {
          color: #333333 !important;
        }

        .card {
          background: #ffffff !important;
          border-radius: 0;
          box-shadow: none !important;
          border: none;
          padding: 0;
          margin: 8px 0;
        }

        .card-top {
          border-bottom: 1px solid #e0e0e0;
          padding: 0 0 4px 0;
          margin-bottom: 4px;
        }

        .card-source {
          color: #000000 !important;
          font-weight: 600;
        }

        .status-bar {
          border: none;
          background: transparent;
          padding-left: 0;
          padding-right: 0;
        }

        .status-title span,
        .status-meta {
          color: #000000 !important;
        }

        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
          color: #000000 !important;
        }

        .markdown-body p,
        .markdown-body li {
          color: #000000 !important;
        }

        a,
        a:visited {
          color: #0000ee !important;
        }

        /* Opcional: mostra URL apÃ³s links no PDF */
        .markdown-body a[href]::after,
        #highlights-list a[href]::after {
          content: " (" attr(href) ")";
          font-size: 11px;
        }

        /* Evita quebrar linhas esquisitas em listas longas */
        #highlights-card,
        #morning-card {
          page-break-inside: avoid;
        }

        /* Destaques para labels tipo "What:", "Why it matters:" etc */
        .mc-label {
          display: inline-block;
          padding: 1px 8px;
          margin-right: 4px;
          border-radius: 999px;
          background: rgba(189,147,249,0.22);
          color: var(--accent-strong);
          font-size: 11px;
          text-transform: uppercase;
          letter-spacing: 0.04em;
        }

        /* Ajuste leve para o texto logo apÃ³s a label */
        .markdown-body li {
          line-height: 1.6;
        }

        /* Se a label estiver no comeÃ§o do parÃ¡grafo, dÃ¡ um respiro */
        .markdown-body p > .mc-label:first-child {
          margin-right: 6px;
        }

      }
    </style>
  </head>

  <body>
    <div class="page">
  <!-- Minimal Navbar -->
  <div class="minimal-navbar">
    

    <div class="minimal-dropdown">
      <span class="minimal-nav-link dropdown-toggle">Insights â–¾</span>
      <div class="dropdown-menu">
        <a href="index.html">News</a>
        <a href="archive.html">Archive List</a>
        <a href="archive-overview.html">Year Overview</a>
        <a href="trend.html">Trend Analytics</a>
      </div>
    </div>
  </div>

      <!-- Header -->
      <header class="site-header">
        <div class="site-title-block">
          <span class="badge badge-live">SOC briefing</span>
          <h1 class="site-title">Daily SOC Morning Call</h1>
          <p class="site-subtitle">
            Curated, AI-assisted morning brief based on the last 24h of security news,
            focused on operational impact for a critical SOC.
          </p>
        </div>
      </header>

      <!-- Layout principal: sidebar + conteÃºdo -->
      <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar">
          <section class="sidebar-section">
            <h2 class="sidebar-title">How this works</h2>
            <p class="sidebar-help">
              This page reads the prebuilt
              <code>morning_call_YYYY-MM-DD.json</code> files under
              <code>data/archive/</code> â€” generated daily from curated news items â€”
              and renders a SOC-oriented morning call.
            </p>
          </section>

          <section class="sidebar-section">
            <h2 class="sidebar-title">Scope</h2>
            <p class="sidebar-help">The analysis focuses on:</p>
            <ul class="sidebar-help" style="padding-left: 18px; margin-top: 6px;">
              <li>Exploitable &amp; high-impact CVEs</li>
              <li>Ransomware and active campaigns</li>
              <li>Critical vendor advisories</li>
              <li>Financial sector and infra threats</li>
            </ul>
          </section>

          <section class="sidebar-section">
            <h2 class="sidebar-title">Tips for analysts</h2>
            <p class="sidebar-help">Use this brief as a starting point for:</p>
            <ul class="sidebar-help" style="padding-left: 18px; margin-top: 6px;">
              <li>Shift handover discussions</li>
              <li>Prioritizing hunts &amp; detections</li>
              <li>Escalation notes for management</li>
            </ul>
          </section>
        </aside>

        <!-- ConteÃºdo principal -->
        <main class="main-content">
          <div class="filters-bar">
            <div class="filters-left">
              <div class="filter-group">
                <span class="filter-label">Data source</span>
                <span class="status-meta">
                  JSON: <code>data/archive/morning_call_YYYY-MM-DD.json</code><br />
                  Alias: <code>data/archive/morning_call_latest.json</code>
                </span>
              </div>
            </div>

            <div class="filters-right">
              <div class="filter-group">
                <span class="filter-label">Latest</span>
                <button id="btn-load-latest" class="btn-pill">ðŸ”„ Load latest</button>
              </div>

              <div class="filter-group">
                <span class="filter-label">History</span>
                <div class="search-input-wrapper">
                  <input type="date" id="previous-date" class="filter-input" />
                  <button id="btn-load-previous" class="btn-pill">ðŸ“… Load by date</button>
                </div>
              </div>

              <div class="filter-group">
                <span class="filter-label">Export</span>
                <button id="btn-print" class="btn-pill btn-pill-secondary">
                  ðŸ–¨ Print / PDF
                </button>
              </div>
            </div>
          </div>

          <!-- Status -->
          <div class="status-bar" id="morning-status" style="margin-top: 4px;">
            <div class="status-left">
              <div class="status-title">
                <span id="status-analysis-date">No analysis loaded</span>
              </div>
              <div class="status-meta" id="status-meta-line">
                Select a date or load the latest morning call.
              </div>
            </div>

            <div class="status-right" id="status-counts"></div>
          </div>

          <!-- Loading -->
          <div class="loading" id="loading-block">
            <div class="spinner"></div>
            <span id="loading-text">Loading morning callâ€¦</span>
          </div>



          <!-- ConteÃºdo do Morning Call -->
          <div class="card" id="morning-card" style="margin-top: 8px;">
            <div class="card-top">
              <div class="card-source" id="morning-header-subtitle">
                Morning call content
              </div>
            </div>
            <div class="card-body">
              <div id="morning-content" class="markdown-body card-body-text">
                <p>No analysis loaded yet. Click "Load latest analysis".</p>
              </div>
            </div>
          </div>

                    <!-- Highlights -->
          <div class="card" id="highlights-card" style="display: none; margin-top: 4px;">
            <div class="card-top">
              <div class="card-source">Key highlights (from curated items)</div>
            </div>
            <div class="card-body">
              <ul
                id="highlights-list"
                class="card-body-text"
                style="padding-left: 18px; margin: 0;"
              ></ul>
            </div>
          </div>

          
        </main>
      </div>

      <!-- Footer -->
      <footer class="site-footer">
        <p>
          Generated daily from curated security feeds â€¢ S33R Security News Feed â€“ SOC Morning Call
        </p>
      </footer>
    </div>

    <script>
      const LATEST_URL = "data/archive/morning_call_latest.json";

      const statusAnalysisDate = document.getElementById("status-analysis-date");
      const statusMetaLine = document.getElementById("status-meta-line");
      const statusCounts = document.getElementById("status-counts");
      const loadingBlock = document.getElementById("loading-block");
      const loadingText = document.getElementById("loading-text");
      const morningContent = document.getElementById("morning-content");
      const highlightsCard = document.getElementById("highlights-card");
      const highlightsList = document.getElementById("highlights-list");

      function showLoading(msg) {
        loadingBlock.classList.remove("hidden");
        loadingBlock.style.display = "flex";
        loadingText.textContent = msg || "Loading morning callâ€¦";
      }

      function hideLoading() {
        loadingBlock.classList.add("hidden");
        loadingBlock.style.display = "none";
      }

      function formatDateForDisplay(iso) {
        if (!iso) return "Unknown date";
        try {
          return new Date(iso).toISOString().slice(0, 10);
        } catch {
          return iso;
        }
      }

      async function fetchMorningCall(url) {
        showLoading();

        try {
          const resp = await fetch(url, { cache: "no-cache" });

          if (!resp.ok) {
            hideLoading();
            morningContent.innerHTML =
              "<p>No analysis available for this date.</p>";
            statusAnalysisDate.textContent = "No analysis loaded";
            statusMetaLine.textContent =
              "Could not load analysis: HTTP " + resp.status;
            statusCounts.textContent = "";
            highlightsCard.style.display = "none";
            return;
          }

          const data = await resp.json();
          hideLoading();

          const analysisDate = data.analysis_date || "";
          const generatedAt = data.generated_at || "";
          const windowHours = data.window_hours || 24;
          const totalAll = data.total_items_in_window_all ?? 0;
          const totalCurated = data.total_items_in_window_curated ?? 0;

          statusAnalysisDate.textContent =
            "Morning call for " + formatDateForDisplay(analysisDate);
          statusMetaLine.textContent =
            `JSON generated at: ${generatedAt} (window: last ${windowHours}h)`;

          statusCounts.textContent =
            `Items in window: ${totalAll} total / ${totalCurated} curated`;

          // Highlights
          const highlights = data.highlights ?? [];
          highlightsList.innerHTML = "";
          if (highlights.length > 0) {
            highlightsCard.style.display = "block";
            highlights.forEach((h) => {
              const li = document.createElement("li");
              const title = h.title || "(no title)";
              const link = h.link || "#";
              const source = h.source || "";
              li.innerHTML = `
                <a href="${link}" target="_blank" class="card-title-link">
                  ${title}
                </a>
                <span style="font-size:11px; color:var(--text-muted); margin-left:6px;">
                  ${source ? "(" + source + ")" : ""}
                </span>`;
              highlightsList.appendChild(li);
            });
          } else {
            highlightsCard.style.display = "none";
          }

          // Markdown â†’ HTML
          const md = data.morning_call_markdown || "No content available.";
          morningContent.innerHTML = marked.parse(md);

          // Depois de renderizar o markdown, destacamos labels SOC
          highlightSocLabels();
        } catch (err) {
          console.error(err);
          hideLoading();
          morningContent.innerHTML =
            "<p>Error loading morning call JSON.</p>";
          statusAnalysisDate.textContent = "No analysis loaded";
          statusMetaLine.textContent = "Error fetching JSON.";
          statusCounts.textContent = "";
          highlightsCard.style.display = "none";
        }
      }

      document
        .getElementById("btn-load-latest")
        .addEventListener("click", () => {
          fetchMorningCall(LATEST_URL);
        });

      document
        .getElementById("btn-load-previous")
        .addEventListener("click", () => {
          const value = document.getElementById("previous-date").value;
          if (!value) return alert("Select a date");
          fetchMorningCall(`data/archive/morning_call_${value}.json`);
        });

      document.getElementById("btn-print").addEventListener("click", () => {
        window.print();
      });
      
      function highlightSocLabels() {
      const LABELS = [
        "What:",
        "What happened:",
        "Why it matters:",
        "Why it matters operationally:",
        "Recommended immediate actions:",
        "Recommended actions:",
        "Log sources:",
        "Log source:",
        "Focus:",
      ];

      const strongNodes = morningContent.querySelectorAll("strong, b");

      strongNodes.forEach((node) => {
        const text = (node.textContent || "").trim();

        // Normaliza para comparaÃ§Ã£o sem case e sem espaÃ§o final
        const normalized = text.replace(/\s+/g, " ").toLowerCase();

        LABELS.forEach((labelRaw) => {
          const labelNorm = labelRaw.replace(/\s+/g, " ").toLowerCase();

          // Se o <strong> for exatamente a label (com ou sem espaÃ§o extra)
          if (normalized === labelNorm || normalized === labelNorm.replace(/:$/, "")) {
            node.classList.add("mc-label");
          }
        });
      });
    }

      window.addEventListener("DOMContentLoaded", () => {
        fetchMorningCall(LATEST_URL);
      });
    </script>
  </body>
</html>
