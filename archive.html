<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>S33R Archive</title>

  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Layout geral archive */

    .archive-container {
      max-width: 980px;
      margin: 0 auto;
      padding: 32px 12px 40px;
      text-align: center;
    }

    .archive-title {
      font-size: 30px;
      font-weight: 800;
      margin-bottom: 6px;
      color: var(--text-primary);
    }

    .archive-subtitle {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 18px;
    }

    /* Card de controles (ano/mês + busca + toggle + stats) */

    .archive-controls {
      background: var(--bg-elevated);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border-color);
      padding: 14px 16px 12px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      text-align: left;
    }

    .archive-controls-top {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
    }

    .archive-selectors {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .archive-selectors select {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: var(--radius);
      font-size: 14px;
      min-width: 90px;
    }

    .archive-tools {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      margin-top: 4px;
    }

    .archive-search-input {
      min-width: 260px;
      max-width: 360px;
      width: 100%;
      padding: 6px 10px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 14px;
    }

    .archive-search-input::placeholder {
      color: var(--text-muted);
    }

    .archive-group-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-muted);
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      cursor: pointer;
      white-space: nowrap;
    }

    .archive-group-toggle input {
      accent-color: var(--accent);
      cursor: pointer;
    }

    /* Stats dentro do card */

    #archive-stats {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .archive-stats-card {
      background: rgba(0, 0, 0, 0.1);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 8px 10px;
    }

    .archive-stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 2px;
    }

    .archive-stats-row span {
      white-space: nowrap;
    }

    .archive-stats-row strong {
      font-weight: 600;
      color: var(--text-secondary);
    }

    /* Lista de resultados */

    #archive-results {
      margin-top: 4px;
      text-align: left;
    }

    .archive-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      padding: 10px 12px;
      border-radius: var(--radius-lg);
      margin-bottom: 10px;
    }

    .archive-date {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .archive-item a {
      text-decoration: none;
      color: var(--accent);
      font-weight: 600;
      font-size: 14px;
    }

    .archive-item a:hover {
      text-decoration: underline;
    }

    .archive-source {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }

    .archive-summary {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .archive-source-header {
      margin-top: 14px;
      margin-bottom: 4px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    /* Paginação */

    .archive-pagination {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .archive-page-btn {
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-color);
      background: var(--bg-elevated);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 13px;
      min-width: 70px;
    }

    .archive-page-btn:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .archive-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .archive-container {
        padding-top: 40px;
      }
      .archive-controls-top {
        flex-direction: column;
        align-items: flex-start;
      }
      .archive-tools {
        justify-content: flex-start;
      }
      .archive-search-input {
        max-width: 100%;
      }
    }
  </style>
</head>

<body>

  <!-- Minimal Navbar -->
  <div class="minimal-navbar">
    <a href="index.html" class="minimal-nav-link">News (24h)</a>
  </div>

  <div class="archive-container">
    <h1 class="archive-title">S33R Archive</h1>
    <p class="archive-subtitle">
      Browse older security news by year and month, with search, grouping and basic analytics.
    </p>

    <div class="archive-controls">
      <div class="archive-controls-top">
        <div class="archive-selectors">
          <select id="year-select">
            <option value="">Select year...</option>
          </select>
          <select id="month-select" disabled>
            <option value="">Select month...</option>
          </select>
        </div>

        <div class="archive-tools">
          <input
            id="search-input"
            class="archive-search-input"
            type="text"
            placeholder="Search in archive (title, summary, source)..."
          />
          <label class="archive-group-toggle">
            <input type="checkbox" id="group-by-source" />
            Group by source
          </label>
        </div>
      </div>

      <div id="archive-stats"></div>
    </div>

    <div id="archive-results"></div>
    <div id="archive-pagination" class="archive-pagination"></div>
  </div>

  <script>
    /* ============================
       Globals
       ============================ */
    const PAGE_SIZE = 25;
    let currentYear = null;
    let currentMonth = null;
    let currentItems = [];
    let filteredItems = [];
    let currentPage = 1;

    /* ============================
       Helpers
       ============================ */

    async function fetchJSON(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) return null;
        return await res.json();
      } catch {
        return null;
      }
    }

    function formatDateFromItem(item) {
      if (typeof item.published_ts === "number") {
        return new Date(item.published_ts * 1000).toLocaleString();
      }
      if (item.published) {
        const d = new Date(item.published);
        if (!isNaN(d.getTime())) {
          return d.toLocaleString();
        }
      }
      return "Unknown date";
    }

    function computeStats(items) {
      const statsEl = document.getElementById("archive-stats");
      if (!items || items.length === 0) {
        statsEl.innerHTML = "";
        return;
      }

      const total = items.length;
      const sourcesCount = {};
      let minTs = Infinity;
      let maxTs = -Infinity;

      items.forEach((item) => {
        const src = item.source || "Unknown";
        sourcesCount[src] = (sourcesCount[src] || 0) + 1;

        let ts = null;
        if (typeof item.published_ts === "number") {
          ts = item.published_ts * 1000;
        } else if (item.published) {
          const d = new Date(item.published);
          if (!isNaN(d.getTime())) ts = d.getTime();
        }
        if (ts !== null) {
          if (ts < minTs) minTs = ts;
          if (ts > maxTs) maxTs = ts;
        }
      });

      const uniqueSources = Object.keys(sourcesCount).length;
      const topSources = Object.entries(sourcesCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const rangeStart = isNaN(minTs) || !isFinite(minTs)
        ? "Unknown"
        : new Date(minTs).toLocaleString();
      const rangeEnd = isNaN(maxTs) || !isFinite(maxTs)
        ? "Unknown"
        : new Date(maxTs).toLocaleString();

      const topSourcesStr = topSources
        .map(([src, count]) => `${src} (${count})`)
        .join(", ");

      statsEl.innerHTML = `
        <div class="archive-stats-card">
          <div class="archive-stats-row">
            <span><strong>Total items:</strong> ${total}</span>
            <span><strong>Sources:</strong> ${uniqueSources}</span>
          </div>
          <div class="archive-stats-row">
            <span><strong>Date range:</strong> ${rangeStart} → ${rangeEnd}</span>
          </div>
          <div class="archive-stats-row">
            <span><strong>Top sources:</strong> ${topSourcesStr || "N/A"}</span>
          </div>
        </div>
      `;
    }

    function applyFilters() {
      const searchTerm = document
        .getElementById("search-input")
        .value.trim()
        .toLowerCase();

      if (!currentItems || currentItems.length === 0) {
        filteredItems = [];
        return;
      }

      if (!searchTerm) {
        filteredItems = currentItems.slice();
      } else {
        filteredItems = currentItems.filter((item) => {
          const title = (item.title || "").toLowerCase();
          const summary = (item.summary || "").toLowerCase();
          const source = (item.source || "").toLowerCase();
          return (
            title.includes(searchTerm) ||
            summary.includes(searchTerm) ||
            source.includes(searchTerm)
          );
        });
      }

      filteredItems.sort((a, b) => {
        const tsA = a.published_ts || 0;
        const tsB = b.published_ts || 0;
        return tsB - tsA;
      });

      currentPage = 1;
    }

    function renderResults() {
      const container = document.getElementById("archive-results");
      const groupBySource = document.getElementById("group-by-source").checked;

      container.innerHTML = "";

      if (!filteredItems || filteredItems.length === 0) {
        container.innerHTML = "<p>No items for this selection.</p>";
        document.getElementById("archive-pagination").innerHTML = "";
        computeStats([]);
        return;
      }

      computeStats(filteredItems);

      const totalPages = Math.max(1, Math.ceil(filteredItems.length / PAGE_SIZE));
      if (currentPage > totalPages) currentPage = totalPages;

      const startIdx = (currentPage - 1) * PAGE_SIZE;
      const endIdx = startIdx + PAGE_SIZE;
      let pageItems = filteredItems.slice(startIdx, endIdx);

      if (groupBySource) {
        pageItems = pageItems.slice().sort((a, b) => {
          const sa = (a.source || "").localeCompare(b.source || "");
          if (sa !== 0) return sa;
          const tsA = a.published_ts || 0;
          const tsB = b.published_ts || 0;
          return tsB - tsA;
        });

        let lastSource = null;
        pageItems.forEach((item) => {
          const src = item.source || "Unknown";
          if (src !== lastSource) {
            const header = document.createElement("div");
            header.className = "archive-source-header";
            header.textContent = src;
            container.appendChild(header);
            lastSource = src;
          }
          container.appendChild(buildItemElement(item));
        });
      } else {
        pageItems.forEach((item) => {
          container.appendChild(buildItemElement(item));
        });
      }

      renderPagination(filteredItems.length);
    }

    function buildItemElement(item) {
      const div = document.createElement("div");
      div.className = "archive-item";

      const dateStr = formatDateFromItem(item);
      const src = item.source || "";
      const summary = item.summary || "";

      div.innerHTML = `
        <div class="archive-date">${dateStr}</div>
        <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>
        ${src ? `<div class="archive-source">${src}</div>` : ""}
        ${summary ? `<div class="archive-summary">${summary}</div>` : ""}
      `;
      return div;
    }

    function renderPagination(totalItems) {
      const pagEl = document.getElementById("archive-pagination");
      if (!totalItems || totalItems <= PAGE_SIZE) {
        pagEl.innerHTML = "";
        return;
      }

      const totalPages = Math.max(1, Math.ceil(totalItems / PAGE_SIZE));

      pagEl.innerHTML = `
        <button class="archive-page-btn" id="page-prev" ${
          currentPage <= 1 ? "disabled" : ""
        }>Previous</button>
        <span>Page ${currentPage} / ${totalPages}</span>
        <button class="archive-page-btn" id="page-next" ${
          currentPage >= totalPages ? "disabled" : ""
        }>Next</button>
        <span class="archive-count">${totalItems} items</span>
      `;

      document.getElementById("page-prev").onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          renderResults();
        }
      };
      document.getElementById("page-next").onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderResults();
        }
      };
    }

    /* ============================
       Year / month loading
       ============================ */

    async function loadYears() {
      const select = document.getElementById("year-select");

      const candidateYears = [2023, 2024, 2025, 2026, 2027];
      for (const y of candidateYears) {
        const exists = await fetchJSON(`data/archive/yearly/${y}.json`);
        if (exists) {
          const opt = document.createElement("option");
          opt.value = y;
          opt.textContent = y;
          select.appendChild(opt);
        }
      }
    }

    function loadMonths(year) {
      const monthSelect = document.getElementById("month-select");
      monthSelect.innerHTML = '<option value="">Select month...</option>';

      const months = [
        "01","02","03","04","05","06",
        "07","08","09","10","11","12"
      ];

      months.forEach((m) => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        monthSelect.appendChild(opt);
      });

      monthSelect.disabled = false;
    }

    async function loadArchive(year, month) {
      const container = document.getElementById("archive-results");
      const statsEl = document.getElementById("archive-stats");
      const pagEl = document.getElementById("archive-pagination");

      container.innerHTML = "<p>Loading...</p>";
      statsEl.innerHTML = "";
      pagEl.innerHTML = "";

      const path = `data/archive/monthly/${year}/${year}-${month}.json`;
      const data = await fetchJSON(path);

      currentYear = year;
      currentMonth = month;
      currentItems = Array.isArray(data) ? data : [];
      applyFilters();
      renderResults();
    }

    /* ============================
       Event Listeners
       ============================ */

    document.getElementById("year-select").addEventListener("change", (e) => {
      const year = e.target.value;
      if (!year) return;
      loadMonths(year);
      currentYear = year;
      currentMonth = null;
      currentItems = [];
      filteredItems = [];
      document.getElementById("archive-results").innerHTML = "";
      document.getElementById("archive-stats").innerHTML = "";
      document.getElementById("archive-pagination").innerHTML = "";
    });

    document.getElementById("month-select").addEventListener("change", (e) => {
      const month = e.target.value;
      const year = document.getElementById("year-select").value;
      if (!year || !month) return;
      loadArchive(year, month);
    });

    document.getElementById("search-input").addEventListener("input", () => {
      applyFilters();
      renderResults();
    });

    document.getElementById("group-by-source").addEventListener("change", () => {
      renderResults();
    });

    /* Initial load */
    loadYears();
  </script>

</body>
</html>
